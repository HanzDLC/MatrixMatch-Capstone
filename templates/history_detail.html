{% extends "base.html" %}
{% block title %}History #{{ history.history_id }} - MatrixMatch{% endblock %}

{% block content %}
<div class="page">
    <div class="page__header">
        <div>
            <h1 class="page__title">History #{{ history.history_id }}</h1>
            <p class="page__subtitle">
                Detailed view of stage 1 matches, semantic sentence links, and stage 2 matrix access.
            </p>
        </div>
        <a href="{{ url_for('history') }}" class="btn btn-secondary">Back to History</a>
    </div>

    <div class="page__content history-detail">
        <div class="history-detail__grid">
            <section class="card">
                <div class="card__header">
                    <div>
                        <h2 class="card__title">Run Summary</h2>
                        <p class="card__subtitle">Core metadata for this comparison run.</p>
                    </div>
                </div>
                <div class="card__body">
                    <dl class="meta-list">
                        <div class="meta-list__row">
                            <dt>History ID</dt>
                            <dd>#{{ history.history_id }}</dd>
                        </div>
                        <div class="meta-list__row">
                            <dt>Researcher</dt>
                            <dd>{{ history.researcher_name }}</dd>
                        </div>
                        <div class="meta-list__row">
                            <dt>Program Filter</dt>
                            <dd>{{ history.academic_program_filter }}</dd>
                        </div>
                        <div class="meta-list__row">
                            <dt>Threshold</dt>
                            <dd>{{ (history.similarity_threshold * 100) | round(0) }}%</dd>
                        </div>
                        <div class="meta-list__row">
                            <dt>Created At</dt>
                            <dd>{{ history.created_at }}</dd>
                        </div>
                    </dl>
                </div>
            </section>

            <section class="card">
                <div class="card__header">
                    <div>
                        <h2 class="card__title">Keywords</h2>
                        <p class="card__subtitle">Terms used for stage 2 similarity scoring.</p>
                    </div>
                </div>
                <div class="card__body">
                    {% if keywords and keywords|length > 0 %}
                        <ul class="keyword-list">
                            {% for kw in keywords %}
                                <li class="keyword-chip">{{ kw }}</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="empty-state">No keywords were saved for this run.</p>
                    {% endif %}
                </div>
            </section>
        </div>

        <section class="card">
            <div class="card__header">
                <div>
                    <h2 class="card__title">Stage 1 Matches</h2>
                    <p class="card__subtitle">
                        Documents that passed the configured semantic similarity threshold.
                    </p>
                </div>
            </div>

            {% if matches and matches|length > 0 %}
                <div class="table-wrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Doc ID</th>
                                <th>Title</th>
                                <th>Program</th>
                                <th>Similarity</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for m in matches %}
                                <tr>
                                    <td>{{ m.document_id }}</td>
                                    <td>{{ m.title }}</td>
                                    <td>{{ m.program }}</td>
                                    <td>{{ (m.similarity * 100) | round(2) }}%</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="empty-state">No stage 1 matches were saved for this history entry.</p>
            {% endif %}
        </section>

        <section class="card">
            <div class="card__header">
                <div>
                    <h2 class="card__title">Semantic Sentence Highlights</h2>
                    <p class="card__subtitle">
                        Hover a sentence or row to trace paired semantic matches across both abstracts.
                    </p>
                </div>
            </div>

            <div class="card__body">
                {% if semantic_highlights and semantic_highlights|length > 0 %}
                    {% for highlight in semantic_highlights %}
                        <div class="mb-3 semantic-highlight-block" data-highlight-doc="{{ highlight.document_id }}">
                            <h3 class="card-title">{{ highlight.title }} (ID:{{ highlight.document_id }})</h3>
                            <p class="card-hint mb-2">
                                Stage 1 Similarity: {{ (highlight.document_similarity * 100) | round(2) }}%
                            </p>

                            <div class="semantic-split">
                                <div class="semantic-box">
                                    <h4>Your Abstract</h4>
                                    <div>
                                        {% for sentence in highlight.user_overview_items %}
                                            <span
                                                class="semantic-sentence{% if sentence.pair_ids and sentence.pair_ids|length > 0 %} semantic-hit{% endif %}"
                                                data-pair-list="{{ sentence.pair_ids | join(',') }}"
                                            >{{ sentence.html | safe }}</span>{% if not loop.last %} {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="semantic-box">
                                    <h4>{{ highlight.title }} Abstract</h4>
                                    <div>
                                        {% for sentence in highlight.doc_overview_items %}
                                            <span
                                                class="semantic-sentence{% if sentence.pair_ids and sentence.pair_ids|length > 0 %} semantic-hit{% endif %}"
                                                data-pair-list="{{ sentence.pair_ids | join(',') }}"
                                            >{{ sentence.html | safe }}</span>{% if not loop.last %} {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <div class="table-wrapper">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Your Sentence</th>
                                            <th>Matched Sentence</th>
                                            <th>Score</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for pair in highlight.pairs %}
                                            <tr
                                                class="semantic-pair-row"
                                                data-pair-id="{{ pair.pair_id }}"
                                                data-user-text="{{ pair.user_sentence_plain | e }}"
                                                data-doc-text="{{ pair.doc_sentence_plain | e }}"
                                                data-score="{{ (pair.similarity * 100) | round(2) }}"
                                            >
                                                <td>{{ pair.user_sentence_html | safe }}</td>
                                                <td>{{ pair.doc_sentence_html | safe }}</td>
                                                <td>{{ (pair.similarity * 100) | round(2) }}%</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="empty-state">
                        No sentence-level semantic overlaps were strong enough for this history entry.
                    </p>
                {% endif %}

                <div class="semantic-hover-card" id="semanticHoverCard" hidden>
                    <h4 class="semantic-hover-card__title">Paired Semantic Sentences</h4>
                    <p class="semantic-hover-card__item" id="semanticHoverUser"></p>
                    <p class="semantic-hover-card__item" id="semanticHoverDoc"></p>
                    <p class="semantic-hover-card__score" id="semanticHoverScore"></p>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card__header">
                <div>
                    <h2 class="card__title">Stage 2 Matrix</h2>
                    <p class="card__subtitle">
                        Open the keyword by document matrix table in a dedicated view.
                    </p>
                </div>
            </div>
            <div class="card__body heatmap-section">
                {% if matches and matches|length > 0 and keywords and keywords|length > 0 %}
                    <p class="mb-2">Open the full table to inspect keyword-level similarity distribution.</p>
                    <a
                        href="{{ url_for('history_heatmap', history_id=history.history_id) }}"
                        target="_blank"
                        class="btn btn-primary btn-sm"
                    >
                        View Heatmap Table
                    </a>
                {% else %}
                    <p class="empty-state">
                        Not enough data to build a matrix. You need both keywords and stage 1 matches.
                    </p>
                {% endif %}
            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/history_detail.js') }}"></script>
{% endblock %}
